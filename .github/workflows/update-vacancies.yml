name: Diagnostic Update

on:
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  diagnostic-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: Test different search periods
        run: |
          echo "=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ê–ó–ù–´–• –ü–ï–†–ò–û–î–û–í –ü–û–ò–°–ö–ê ==="
          
          python3 << 'EOF'
          import requests
          import json
          from datetime import datetime, timedelta
          
          url = "https://api.hh.ru/vacancies"
          headers = {'User-Agent': 'VacancyBot/1.0'}
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
          periods = [
              ('1', '–ó–∞ 1 –¥–µ–Ω—å'),
              ('3', '–ó–∞ 3 –¥–Ω—è'), 
              ('7', '–ó–∞ 7 –¥–Ω–µ–π'),
              ('30', '–ó–∞ 30 –¥–Ω–µ–π')
          ]
          
          all_results = {}
          
          for period_num, period_desc in periods:
              print(f"\n--- {period_desc} (search_period={period_num}) ---")
              
              params = {
                  'text': '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                  'area': '113',
                  'search_field': 'name',
                  'order_by': 'publication_time',  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                  'search_period': period_num,
                  'per_page': '20'
              }
              
              try:
                  response = requests.get(url, params=params, headers=headers, timeout=30)
                  print(f"–°—Ç–∞—Ç—É—Å: {response.status_code}")
                  
                  if response.status_code == 200:
                      data = response.json()
                      items = data.get('items', [])
                      found = data.get('found', 0)
                      
                      print(f"–ù–∞–π–¥–µ–Ω–æ –≤—Å–µ–≥–æ: {found}")
                      print(f"–ü–æ–ª—É—á–µ–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {len(items)}")
                      
                      if items:
                          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—ã –ø–µ—Ä–≤—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π
                          for i, item in enumerate(items[:3]):
                              pub_date = item.get('published_at', '')
                              name = item.get('name', '')[:50]
                              print(f"  {i+1}. {pub_date} - {name}...")
                          
                          all_results[period_num] = {
                              'total_found': found,
                              'received': len(items),
                              'items': items
                          }
                      else:
                          print("  –ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π")
                          all_results[period_num] = {
                              'total_found': 0,
                              'received': 0,
                              'items': []
                          }
                  else:
                      print(f"–û—à–∏–±–∫–∞: {response.status_code}")
                      print(f"–û—Ç–≤–µ—Ç: {response.text}")
                      
              except Exception as e:
                  print(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
          
          # –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –ø–µ—Ä–∏–æ–¥ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–∞–∫–∞–Ω—Å–∏–π
          best_period = '7'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π
          max_found = 0
          
          for period, result in all_results.items():
              if result['total_found'] > max_found:
                  max_found = result['total_found']
                  best_period = period
          
          print(f"\n=== –í–´–ë–†–ê–ù –õ–£–ß–®–ò–ô –ü–ï–†–ò–û–î: {best_period} –¥–Ω–µ–π (–Ω–∞–π–¥–µ–Ω–æ: {max_found}) ===")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          with open('best_period.txt', 'w') as f:
              f.write(best_period)
              
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ª—É—á—à–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
          if best_period in all_results:
              best_data = all_results[best_period]
              with open('vacancies_data.json', 'w', encoding='utf-8') as f:
                  json.dump(best_data, f, ensure_ascii=False, indent=2)
              print(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ {best_period} –¥–Ω–µ–π")
          EOF
          
      - name: Create comprehensive JSON
        run: |
          echo "=== –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–ù–û–ì–û JSON –° –ê–ö–¢–£–ê–õ–¨–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò ==="
          
          python3 << 'EOF'
          import requests
          import json
          from datetime import datetime
          import time
          
          # –ß–∏—Ç–∞–µ–º –ª—É—á—à–∏–π –ø–µ—Ä–∏–æ–¥
          with open('best_period.txt', 'r') as f:
              best_period = f.read().strip()
              
          print(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–∏–æ–¥: {best_period} –¥–Ω–µ–π")
          
          url = "https://api.hh.ru/vacancies"
          headers = {'User-Agent': 'VacancyBot/1.0'}
          
          all_vacancies = []
          
          # –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞–º–∏
          search_configs = [
              {
                  'order_by': 'publication_time',
                  'name': '–ü–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'
              },
              {
                  'order_by': 'salary_desc', 
                  'name': '–ü–æ –∑–∞—Ä–ø–ª–∞—Ç–µ'
              }
          ]
          
          for config in search_configs:
              print(f"\n--- –ü–æ–∏—Å–∫: {config['name']} ---")
              
              params = {
                  'text': '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                  'area': '113',
                  'search_field': 'name',
                  'order_by': config['order_by'],
                  'search_period': best_period,
                  'per_page': '100'
              }
              
              try:
                  response = requests.get(url, params=params, headers=headers, timeout=30)
                  print(f"–°—Ç–∞—Ç—É—Å: {response.status_code}")
                  
                  if response.status_code == 200:
                      data = response.json()
                      items = data.get('items', [])
                      print(f"–ü–æ–ª—É—á–µ–Ω–æ: {len(items)} –≤–∞–∫–∞–Ω—Å–∏–π")
                      
                      all_vacancies.extend(items)
                  else:
                      print(f"–û—à–∏–±–∫–∞: {response.status_code}")
                      
              except Exception as e:
                  print(f"–û—à–∏–±–∫–∞: {e}")
          
          # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID
          unique_vacancies = {}
          for item in all_vacancies:
              vacancy_id = item.get('id')
              if vacancy_id and vacancy_id not in unique_vacancies:
                  unique_vacancies[vacancy_id] = item
          
          final_vacancies = list(unique_vacancies.values())
          print(f"\n–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π: {len(final_vacancies)}")
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏
          processed_vacancies = []
          for item in final_vacancies:
              # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
              pub_date = item.get('published_at', '')
              formatted_date = pub_date
              if pub_date:
                  try:
                      dt = datetime.fromisoformat(pub_date.replace('Z', '+00:00'))
                      formatted_date = dt.strftime('%d.%m.%Y %H:%M')
                  except:
                      pass
              
              vacancy = {
                  'id': item.get('id'),
                  'name': item.get('name', ''),
                  'company': item.get('employer', {}).get('name', '') if item.get('employer') else '',
                  'company_url': item.get('employer', {}).get('alternate_url', '') if item.get('employer') else '',
                  'url': item.get('alternate_url', ''),
                  'published_at': pub_date,
                  'published_date_formatted': formatted_date,
                  'area': item.get('area', {}).get('name', '') if item.get('area') else '',
                  'salary': item.get('salary'),
                  'snippet': item.get('snippet', {}),
                  'experience': item.get('experience', {}).get('name', '') if item.get('experience') else '',
                  'employment': item.get('employment', {}).get('name', '') if item.get('employment') else '',
                  'schedule': item.get('schedule', {}).get('name', '') if item.get('schedule') else ''
              }
              processed_vacancies.append(vacancy)
          
          # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
          processed_vacancies.sort(key=lambda x: x.get('published_at', ''), reverse=True)
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π JSON —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          current_time = datetime.now()
          result = {
              'updated_at': current_time.isoformat(),
              'unix_timestamp': int(time.time()),
              'diagnostic_update': True,
              'search_period_used': f"{best_period} –¥–Ω–µ–π",
              'total_count': len(processed_vacancies),
              'status': 'diagnostic_success',
              'update_method': 'comprehensive_search',
              'api_source': 'HeadHunter',
              'creation_time': current_time.strftime('%d.%m.%Y %H:%M:%S'),
              'vacancies': processed_vacancies
          }
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
          if processed_vacancies:
              newest = processed_vacancies[0].get('published_date_formatted', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
              oldest = processed_vacancies[-1].get('published_date_formatted', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
              print(f"–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç: {oldest} - {newest}")
              result['date_range'] = {
                  'newest': newest,
                  'oldest': oldest
              }
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
          with open('hh_vacancies.json', 'w', encoding='utf-8') as f:
              json.dump(result, f, ensure_ascii=False, indent=2)
          
          import os
          if os.path.exists('hh_vacancies.json'):
              size = os.path.getsize('hh_vacancies.json')
              print(f"\n‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω! –†–∞–∑–º–µ—Ä: {size} –±–∞–π—Ç")
              print(f"üìä –°–æ–¥–µ—Ä–∂–∏—Ç: {len(processed_vacancies)} –≤–∞–∫–∞–Ω—Å–∏–π")
          EOF
          
      - name: Upload to FTP
        run: |
          echo "=== –ó–ê–ì–†–£–ó–ö–ê –ù–ê FTP ==="
          
          if [ -f "hh_vacancies.json" ]; then
            echo "–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª..."
            
            curl -v -T hh_vacancies.json \
              ftp://${{ secrets.FTP_SERVER }}/www/Vacancy/hh_vacancies.json \
              --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
              --ftp-create-dirs
              
            echo "‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            echo "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(stat -c%s hh_vacancies.json) –±–∞–π—Ç"
          else
            echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
          
      - name: Verification
        run: |
          echo "=== –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê ==="
          echo "üåê –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω: https://gradelift.ru/Vacancy/hh_vacancies.json"
          echo "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤–∞–∫–∞–Ω—Å–∏—è–º–∏: https://gradelift.ru/Vacancy/vacancy_aggregator.html"
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
          echo "1. –ò–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–∞ FTP"
          echo "2. –û–±–Ω–æ–≤–∏–ª–æ—Å—å –ª–∏ –≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏"
          echo "3. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ª–∏ –Ω–æ–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ"
