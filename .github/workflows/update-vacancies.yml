name: Full FTP Diagnostic

on:
  workflow_dispatch: # Ручной запуск

jobs:
  diagnose-ftp:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create test file
        run: |
          echo "=== СОЗДАНИЕ ТЕСТОВОГО ФАЙЛА ==="
          
          # Создаем простой тестовый файл
          cat > test_upload.txt << EOF
          Тест загрузки файла на FTP
          Время: $(date)
          Уникальный ID: $(date +%s)
          EOF
          
          echo "Создан тестовый файл:"
          cat test_upload.txt
          
      - name: Test different FTP paths
        run: |
          echo "=== ТЕСТИРОВАНИЕ РАЗНЫХ ПУТЕЙ FTP ==="
          
          echo "1. Тест корневой директории"
          curl -v -T test_upload.txt \
            ftp://${{ secrets.FTP_SERVER }}/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            -o /dev/null || echo "Корневая директория не удалась"
          
          echo ""
          echo "2. Тест папки /home/"
          curl -v -T test_upload.txt \
            ftp://${{ secrets.FTP_SERVER }}/home/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            --ftp-create-dirs -o /dev/null || echo "Папка /home/ не удалась"
          
          echo ""
          echo "3. Тест папки /home/c54971/"
          curl -v -T test_upload.txt \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            --ftp-create-dirs -o /dev/null || echo "Папка /home/c54971/ не удалась"
          
          echo ""
          echo "4. Тест полного пути"
          curl -v -T test_upload.txt \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/gradelift.ru/Vacancy/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            --ftp-create-dirs -o /dev/null || echo "Полный путь не удался"
          
      - name: List FTP directories
        run: |
          echo "=== ПРОСМОТР СОДЕРЖИМОГО FTP ДИРЕКТОРИЙ ==="
          
          echo "1. Содержимое корневой директории:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Не удалось получить список корневой директории"
          
          echo ""
          echo "2. Содержимое /home/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/home/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Не удалось получить список /home/"
          
          echo ""
          echo "3. Содержимое /home/c54971/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Не удалось получить список /home/c54971/"
          
          echo ""
          echo "4. Содержимое /home/c54971/gradelift.ru/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/gradelift.ru/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Не удалось получить список /home/c54971/gradelift.ru/"
          
          echo ""
          echo "5. Содержимое /home/c54971/gradelift.ru/Vacancy/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/gradelift.ru/Vacancy/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Не удалось получить список /home/c54971/gradelift.ru/Vacancy/"
          
      - name: Test alternative paths
        run: |
          echo "=== ТЕСТИРОВАНИЕ АЛЬТЕРНАТИВНЫХ ПУТЕЙ ==="
          
          echo "Возможно путь другой. Тестируем варианты:"
          
          echo "1. Тест пути /public_html/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/public_html/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Путь /public_html/ не существует"
          
          echo ""
          echo "2. Тест пути /www/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/www/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Путь /www/ не существует"
          
          echo ""
          echo "3. Тест пути /domains/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/domains/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Путь /domains/ не существует"
          
          echo ""
          echo "4. Тест пути без /home/:"
          curl -v --list-only \
            ftp://${{ secrets.FTP_SERVER }}/c54971/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Путь /c54971/ не существует"
          
      - name: Create JSON and upload to working path
        run: |
          echo "=== СОЗДАНИЕ JSON И ЗАГРУЗКА В РАБОЧИЙ ПУТЬ ==="
          
          # Создаем JSON файл
          cat > hh_vacancies.json << 'EOF'
          {
            "created_at": "2025-06-11T14:00:00.000Z",
            "total_count": 0,
            "status": "diagnostic_test",
            "message": "Этот файл создан для диагностики FTP загрузки",
            "test_timestamp": "1686484800",
            "vacancies": []
          }
          EOF
          
          echo "JSON файл создан:"
          cat hh_vacancies.json
          
          echo ""
          echo "Пытаемся загрузить в несколько локаций:"
          
          # Пробуем загрузить в разные места
          echo "1. Загрузка в корень:"
          curl -v -T hh_vacancies.json \
            ftp://${{ secrets.FTP_SERVER }}/hh_vacancies_root.json \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" || echo "Загрузка в корень не удалась"
          
          echo ""
          echo "2. Загрузка в /home/c54971/:"
          curl -v -T hh_vacancies.json \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/hh_vacancies_c54971.json \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" --ftp-create-dirs || echo "Загрузка в /home/c54971/ не удалась"
          
          echo ""
          echo "3. Загрузка в /home/c54971/gradelift.ru/:"
          curl -v -T hh_vacancies.json \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/gradelift.ru/hh_vacancies_gradelift.json \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" --ftp-create-dirs || echo "Загрузка в gradelift.ru не удалась"
          
          echo ""
          echo "4. Загрузка в целевую папку:"
          curl -v -T hh_vacancies.json \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/gradelift.ru/Vacancy/hh_vacancies.json \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" --ftp-create-dirs || echo "Загрузка в Vacancy не удалась"
          
      - name: Final verification
        run: |
          echo "=== ФИНАЛЬНАЯ ПРОВЕРКА ==="
          echo "Диагностика завершена!"
          echo ""
          echo "Проверьте в файловом менеджере хостинга наличие тестовых файлов:"
          echo "- test_upload.txt (в разных папках)"
          echo "- hh_vacancies_root.json (в корне)"
          echo "- hh_vacancies_c54971.json (в /home/c54971/)"
          echo "- hh_vacancies_gradelift.json (в /home/c54971/gradelift.ru/)"
          echo "- hh_vacancies.json (в /home/c54971/gradelift.ru/Vacancy/)"
          echo ""
          echo "Один из этих файлов должен появиться, если FTP работает правильно."
