name: Update Vacancies

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 6 Ñ‡Ð°ÑÐ¾Ð²
    - cron: '0 */6 * * *'
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
    inputs:
      force_update:
        description: 'ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ'
        required: false
        default: 'false'

jobs:
  update-vacancies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: Update vacancies data
        run: |
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd ${{ github.workspace }}
          
          echo "=== Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ JSON Ñ„Ð°Ð¹Ð»Ðµ ==="
          if [ -f "hh_vacancies.json" ]; then
            ls -la hh_vacancies.json
            echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°:"
            head -5 hh_vacancies.json
          else
            echo "Ð¤Ð°Ð¹Ð» hh_vacancies.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€ÑÐ¼Ð¾ Ð·Ð´ÐµÑÑŒ
          cat > simple_update.py << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          
          def main():
              print("=== ÐŸÐžÐ›ÐÐÐ¯ ÐŸÐ•Ð Ð•Ð—ÐÐŸÐ˜Ð¡Ð¬ Ð”ÐÐÐÐ«Ð¥ Ðž Ð’ÐÐšÐÐÐ¡Ð˜Ð¯Ð¥ ===")
              print(f"Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: {os.getcwd()}")
              print(f"Ð’Ñ€ÐµÐ¼Ñ: {datetime.now()}")
              
              # Ð’Ð¡Ð•Ð“Ð”Ð ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¿ÐµÑ€ÐµÐ´ Ð½Ð°Ñ‡Ð°Ð»Ð¾Ð¼
              filename = 'hh_vacancies.json'
              if os.path.exists(filename):
                  old_size = os.path.getsize(filename)
                  os.remove(filename)
                  print(f"âœ… Ð¡Ñ‚Ð°Ñ€Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑƒÐ´Ð°Ð»ÐµÐ½ (Ð±Ñ‹Ð» {old_size} Ð±Ð°Ð¹Ñ‚)")
              else:
                  print("â„¹ï¸ Ð¡Ñ‚Ð°Ñ€Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ Ð±Ñ‹Ð»Ð¾")
              
              url = "https://api.hh.ru/vacancies"
              headers = {'User-Agent': 'VacancyBot/1.0'}
              params = {
                  'text': 'ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€', 
                  'area': '113',
                  'per_page': '50'  # Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð·Ð°Ð¼ÐµÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ñ‹
              }
              
              print(f"ðŸ”„ Ð—Ð°Ð¿Ñ€Ð¾Ñ Ðº API: {url}")
              print(f"ðŸ“‹ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹: {params}")
              
              try:
                  response = requests.get(url, params=params, headers=headers, timeout=30)
                  print(f"ðŸ“¡ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: {response.status_code}")
                  
                  if response.status_code == 200:
                      data = response.json()
                      items = data.get('items', [])
                      print(f"âœ… ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {len(items)} Ð½Ð¾Ð²Ñ‹Ñ… Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹")
                      
                      if len(items) == 0:
                          print("âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ 0 Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹!")
                          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹ Ð½ÐµÑ‚
                          result = {
                              'updated_at': datetime.now().isoformat(),
                              'total_count': 0,
                              'status': 'no_vacancies_found',
                              'source': 'HeadHunter API',
                              'search_params': params,
                              'vacancies': []
                          }
                      else:
                          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐÐžÐ’Ð£Ð® ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð±ÐµÐ· ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…)
                          result = {
                              'updated_at': datetime.now().isoformat(),
                              'total_count': len(items),
                              'status': 'success',
                              'source': 'HeadHunter API',
                              'search_params': params,
                              'vacancies': []
                          }
                          
                          print("ðŸ”„ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¸...")
                          for i, item in enumerate(items):
                              # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                              pub_date = item.get('published_at', '')
                              formatted_date = pub_date
                              if pub_date:
                                  try:
                                      dt = datetime.fromisoformat(pub_date.replace('Z', '+00:00'))
                                      formatted_date = dt.strftime('%d.%m.%Y %H:%M')
                                  except:
                                      pass
                              
                              vacancy = {
                                  'id': item.get('id'),
                                  'name': item.get('name', ''),
                                  'company': item.get('employer', {}).get('name', '') if item.get('employer') else '',
                                  'company_url': item.get('employer', {}).get('alternate_url', '') if item.get('employer') else '',
                                  'url': item.get('alternate_url', ''),
                                  'published_at': pub_date,
                                  'published_date_formatted': formatted_date,
                                  'area': item.get('area', {}).get('name', '') if item.get('area') else '',
                                  'salary': item.get('salary'),
                                  'snippet': item.get('snippet', {}),
                                  'experience': item.get('experience', {}).get('name', '') if item.get('experience') else '',
                                  'employment': item.get('employment', {}).get('name', '') if item.get('employment') else '',
                                  'schedule': item.get('schedule', {}).get('name', '') if item.get('schedule') else ''
                              }
                              result['vacancies'].append(vacancy)
                              
                              if (i + 1) % 10 == 0:
                                  print(f"   ðŸ“ ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ {i + 1} Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹...")
                      
                      # Ð¡ÐžÐ—Ð”ÐÐ•Ðœ ÐŸÐžÐ›ÐÐžÐ¡Ð¢Ð¬Ð® ÐÐžÐ’Ð«Ð™ Ð¤ÐÐ™Ð›
                      print(f"ðŸ’¾ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»: {filename}")
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          json.dump(result, f, ensure_ascii=False, indent=2)
                      
                      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
                      if os.path.exists(filename):
                          new_size = os.path.getsize(filename)
                          print(f"âœ… ÐÐžÐ’Ð«Ð™ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½! Ð Ð°Ð·Ð¼ÐµÑ€: {new_size} Ð±Ð°Ð¹Ñ‚")
                          print(f"ðŸ“Š Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ {len(result['vacancies'])} Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹")
                          print(f"ðŸ•’ Ð’Ñ€ÐµÐ¼Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: {result['updated_at']}")
                          
                          return True
                      else:
                          print("âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½!")
                          return False
                  else:
                      print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° API: {response.status_code}")
                      print(f"ðŸ“„ ÐžÑ‚Ð²ÐµÑ‚: {response.text}")
                      
                      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
                      error_result = {
                          'updated_at': datetime.now().isoformat(),
                          'total_count': 0,
                          'status': 'api_error',
                          'error_code': response.status_code,
                          'error_message': response.text,
                          'vacancies': []
                      }
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          json.dump(error_result, f, ensure_ascii=False, indent=2)
                      
                      return False
              except Exception as e:
                  print(f"âŒ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {e}")
                  import traceback
                  traceback.print_exc()
                  
                  # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
                  error_result = {
                      'updated_at': datetime.now().isoformat(),
                      'total_count': 0,
                      'status': 'system_error',
                      'error_message': str(e),
                      'vacancies': []
                  }
                  
                  with open(filename, 'w', encoding='utf-8') as f:
                      json.dump(error_result, f, ensure_ascii=False, indent=2)
                  
                  return False
          
          if __name__ == "__main__":
              success = main()
              print(f"ðŸ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: {'Ð£Ð¡ÐŸÐ•Ð¥' if success else 'ÐžÐ¨Ð˜Ð‘ÐšÐ'}")
              exit(0 if success else 1)
          EOF
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
          python simple_update.py
          
          echo "=== Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ„Ð°Ð¹Ð»Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ==="
          if [ -f "hh_vacancies.json" ]; then
            ls -la hh_vacancies.json
            echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°:"
            head -5 hh_vacancies.json
          else
            echo "ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð¤Ð°Ð¹Ð» hh_vacancies.json Ð½Ðµ Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½!"
          fi
          
      - name: Commit changes (if any)
        run: |
          # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          cd ${{ github.workspace }}
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐµ
          if [[ -n $(git status --porcelain) ]]; then
            git add hh_vacancies.json
            git commit -m "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹ $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°"
          fi
          
      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: "./"
          server-dir: "/home/c54971/gradelift.ru/Vacancy/"
          state-name: ".ftp-deploy-sync-state.json"
          dry-run: false
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/README.md
            **/.ftp-deploy-sync-state.json
            **/update_vacancies.py
