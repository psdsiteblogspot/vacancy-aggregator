name: Update Vacancies

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
    - cron: '0 */6 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    inputs:
      force_update:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
        required: false
        default: 'false'

jobs:
  update-vacancies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: Update vacancies data
        run: |
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          cd ${{ github.workspace }}
          
          echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º JSON —Ñ–∞–π–ª–µ ==="
          if [ -f "hh_vacancies.json" ]; then
            ls -la hh_vacancies.json
            echo "–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∞–π–ª–∞:"
            head -5 hh_vacancies.json
          else
            echo "–§–∞–π–ª hh_vacancies.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø—Ä—è–º–æ –∑–¥–µ—Å—å
          cat > simple_update.py << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          
          def main():
              print("=== –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–ó–ê–ü–ò–°–¨ –î–ê–ù–ù–´–• –û –í–ê–ö–ê–ù–°–ò–Ø–• ===")
              print(f"–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.getcwd()}")
              print(f"–í—Ä–µ–º—è: {datetime.now()}")
              
              # –í–°–ï–ì–î–ê —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
              filename = 'hh_vacancies.json'
              if os.path.exists(filename):
                  old_size = os.path.getsize(filename)
                  os.remove(filename)
                  print(f"‚úÖ –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω (–±—ã–ª {old_size} –±–∞–π—Ç)")
              else:
                  print("‚ÑπÔ∏è –°—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ –±—ã–ª–æ")
              
              url = "https://api.hh.ru/vacancies"
              headers = {'User-Agent': 'VacancyBot/1.0'}
              params = {
                  'text': '—Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 
                  'area': '113',
                  'per_page': '50'  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ–π —Ä–∞–∑–Ω–∏—Ü—ã
              }
              
              print(f"üîÑ –ó–∞–ø—Ä–æ—Å –∫ API: {url}")
              print(f"üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {params}")
              
              try:
                  response = requests.get(url, params=params, headers=headers, timeout=30)
                  print(f"üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: {response.status_code}")
                  
                  if response.status_code == 200:
                      data = response.json()
                      items = data.get('items', [])
                      print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(items)} –Ω–æ–≤—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π")
                      
                      if len(items) == 0:
                          print("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ–ª—É—á–µ–Ω–æ 0 –≤–∞–∫–∞–Ω—Å–∏–π!")
                          # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª –¥–∞–∂–µ –µ—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–µ—Ç
                          result = {
                              'updated_at': datetime.now().isoformat(),
                              'total_count': 0,
                              'status': 'no_vacancies_found',
                              'source': 'HeadHunter API',
                              'search_params': params,
                              'vacancies': []
                          }
                      else:
                          # –°–æ–∑–¥–∞–µ–º –ù–û–í–£–Æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
                          result = {
                              'updated_at': datetime.now().isoformat(),
                              'total_count': len(items),
                              'status': 'success',
                              'source': 'HeadHunter API',
                              'search_params': params,
                              'vacancies': []
                          }
                          
                          print("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏...")
                          for i, item in enumerate(items):
                              # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                              pub_date = item.get('published_at', '')
                              formatted_date = pub_date
                              if pub_date:
                                  try:
                                      dt = datetime.fromisoformat(pub_date.replace('Z', '+00:00'))
                                      formatted_date = dt.strftime('%d.%m.%Y %H:%M')
                                  except:
                                      pass
                              
                              vacancy = {
                                  'id': item.get('id'),
                                  'name': item.get('name', ''),
                                  'company': item.get('employer', {}).get('name', '') if item.get('employer') else '',
                                  'company_url': item.get('employer', {}).get('alternate_url', '') if item.get('employer') else '',
                                  'url': item.get('alternate_url', ''),
                                  'published_at': pub_date,
                                  'published_date_formatted': formatted_date,
                                  'area': item.get('area', {}).get('name', '') if item.get('area') else '',
                                  'salary': item.get('salary'),
                                  'snippet': item.get('snippet', {}),
                                  'experience': item.get('experience', {}).get('name', '') if item.get('experience') else '',
                                  'employment': item.get('employment', {}).get('name', '') if item.get('employment') else '',
                                  'schedule': item.get('schedule', {}).get('name', '') if item.get('schedule') else ''
                              }
                              result['vacancies'].append(vacancy)
                              
                              if (i + 1) % 10 == 0:
                                  print(f"   üìù –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {i + 1} –≤–∞–∫–∞–Ω—Å–∏–π...")
                      
                      # –°–û–ó–î–ê–ï–ú –ü–û–õ–ù–û–°–¢–¨–Æ –ù–û–í–´–ô –§–ê–ô–õ
                      print(f"üíæ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª: {filename}")
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          json.dump(result, f, ensure_ascii=False, indent=2)
                      
                      # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                      if os.path.exists(filename):
                          new_size = os.path.getsize(filename)
                          print(f"‚úÖ –ù–û–í–´–ô —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω! –†–∞–∑–º–µ—Ä: {new_size} –±–∞–π—Ç")
                          print(f"üìä –°–æ–¥–µ—Ä–∂–∏—Ç {len(result['vacancies'])} –≤–∞–∫–∞–Ω—Å–∏–π")
                          print(f"üïí –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {result['updated_at']}")
                          
                          return True
                      else:
                          print("‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!")
                          return False
                  else:
                      print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}")
                      print(f"üìÑ –û—Ç–≤–µ—Ç: {response.text}")
                      
                      # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
                      error_result = {
                          'updated_at': datetime.now().isoformat(),
                          'total_count': 0,
                          'status': 'api_error',
                          'error_code': response.status_code,
                          'error_message': response.text,
                          'vacancies': []
                      }
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          json.dump(error_result, f, ensure_ascii=False, indent=2)
                      
                      return False
              except Exception as e:
                  print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
                  import traceback
                  traceback.print_exc()
                  
                  # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
                  error_result = {
                      'updated_at': datetime.now().isoformat(),
                      'total_count': 0,
                      'status': 'system_error',
                      'error_message': str(e),
                      'vacancies': []
                  }
                  
                  with open(filename, 'w', encoding='utf-8') as f:
                      json.dump(error_result, f, ensure_ascii=False, indent=2)
                  
                  return False
          
          if __name__ == "__main__":
              success = main()
              print(f"üèÅ –†–µ–∑—É–ª—å—Ç–∞—Ç: {'–£–°–ü–ï–•' if success else '–û–®–ò–ë–ö–ê'}")
              exit(0 if success else 1)
          EOF
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
          python simple_update.py
          
          echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ==="
          if [ -f "hh_vacancies.json" ]; then
            ls -la hh_vacancies.json
            echo "–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:"
            head -5 hh_vacancies.json
          else
            echo "–û–®–ò–ë–ö–ê: –§–∞–π–ª hh_vacancies.json –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!"
          fi
          
      - name: Force commit and push changes
        run: |
          cd ${{ github.workspace }}
          
          echo "=== –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ==="
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
          git add hh_vacancies.json -f
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω—è–µ–º —Ñ–∞–π–ª —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç
            echo "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $(date)" >> hh_vacancies.json
            git add hh_vacancies.json -f
          fi
          
          # –î–µ–ª–∞–µ–º –∫–æ–º–º–∏—Ç
          git commit -m "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–π $(date '+%Y-%m-%d %H:%M:%S')" || echo "–ö–æ–º–º–∏—Ç –Ω–µ —É–¥–∞–ª—Å—è"
          git push || echo "Push –Ω–µ —É–¥–∞–ª—Å—è"
          
          echo "=== –°—Ç–∞—Ç—É—Å git –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ ==="
          git status
          
      - name: Commit changes (if any)
        run: |
          echo "‚è≠Ô∏è –®–∞–≥ –∫–æ–º–º–∏—Ç–∞ –ø—Ä–æ–ø—É—â–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç –≤—ã—à–µ"
          
      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: "./"
          server-dir: "/home/c54971/gradelift.ru/Vacancy/"
          state-name: ".ftp-deploy-sync-state.json"
          dry-run: false
          log-level: verbose
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/README.md
            **/update_vacancies.py
            **/simple_update.py
            
      - name: Verify deployment
        run: |
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –¥–µ–ø–ª–æ—è ==="
          echo "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:"
          ls -la hh_vacancies.json || echo "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ updated_at –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:"
          grep -o '"updated_at":[^,]*' hh_vacancies.json || echo "updated_at –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
