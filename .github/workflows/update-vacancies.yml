name: Update Vacancies (Debug)

on:
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
    inputs:
      force_update:
        description: 'ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ'
        required: false
        default: 'true'

jobs:
  update-vacancies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: Debug - Check initial state
        run: |
          echo "=== ÐÐÐ§ÐÐ›Ð¬ÐÐžÐ• Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð• ==="
          echo "Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:"
          ls -la
          echo "Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ hh_vacancies.json?"
          if [ -f "hh_vacancies.json" ]; then
            echo "Ð”Ð - Ñ€Ð°Ð·Ð¼ÐµÑ€: $(stat -c%s hh_vacancies.json) Ð±Ð°Ð¹Ñ‚"
          else
            echo "ÐÐ•Ð¢ - Ñ„Ð°Ð¹Ð» Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
          fi
          
      - name: Create JSON file (guaranteed)
        run: |
          echo "=== ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ• Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• JSON Ð¤ÐÐ™Ð›Ð ==="
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ JSON Ñ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼
          cat > hh_vacancies.json << EOF
          {
            "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "total_count": 0,
            "status": "manual_test_creation",
            "message": "Ð¤Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ",
            "timestamp": "$(date)",
            "test_data": true,
            "vacancies": []
          }
          EOF
          
          echo "âœ… JSON Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾"
          echo "Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°: $(stat -c%s hh_vacancies.json) Ð±Ð°Ð¹Ñ‚"
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð°:"
          cat hh_vacancies.json
          
      - name: Try to get real vacancies
        run: |
          echo "=== ÐŸÐžÐŸÐ«Ð¢ÐšÐ ÐŸÐžÐ›Ð£Ð§Ð˜Ð¢Ð¬ Ð Ð•ÐÐ›Ð¬ÐÐ«Ð• Ð’ÐÐšÐÐÐ¡Ð˜Ð˜ ==="
          
          python3 << 'EOF'
          import requests
          import json
          from datetime import datetime
          
          def create_vacancies_file():
              print("ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¸ Ñ HeadHunter...")
              
              try:
                  url = "https://api.hh.ru/vacancies"
                  headers = {'User-Agent': 'Mozilla/5.0 (compatible; VacancyBot)'}
                  params = {
                      'text': 'ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€',
                      'area': '113',
                      'per_page': '10'
                  }
                  
                  print(f"URL: {url}")
                  print(f"ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹: {params}")
                  
                  response = requests.get(url, params=params, headers=headers, timeout=30)
                  print(f"Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: {response.status_code}")
                  
                  if response.status_code == 200:
                      data = response.json()
                      items = data.get('items', [])
                      print(f"ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {len(items)} Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹")
                      
                      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
                      result = {
                          'updated_at': datetime.now().isoformat(),
                          'total_count': len(items),
                          'status': 'success_with_real_data',
                          'api_response_code': response.status_code,
                          'vacancies': []
                      }
                      
                      for item in items[:10]:  # Ð‘ÐµÑ€ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10
                          vacancy = {
                              'id': item.get('id'),
                              'name': item.get('name', ''),
                              'company': item.get('employer', {}).get('name', '') if item.get('employer') else '',
                              'url': item.get('alternate_url', ''),
                              'published_at': item.get('published_at', ''),
                              'area': item.get('area', {}).get('name', '') if item.get('area') else ''
                          }
                          result['vacancies'].append(vacancy)
                      
                      # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
                      with open('hh_vacancies.json', 'w', encoding='utf-8') as f:
                          json.dump(result, f, ensure_ascii=False, indent=2)
                      
                      print("âœ… Ð¤Ð°Ð¹Ð» Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸")
                      return True
                  else:
                      print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° API: {response.status_code}")
                      print(f"ÐžÑ‚Ð²ÐµÑ‚: {response.text}")
                      return False
                      
              except Exception as e:
                  print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")
                  return False
          
          success = create_vacancies_file()
          print(f"Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: {'Ð£Ð¡ÐŸÐ•Ð¥' if success else 'ÐžÐ¨Ð˜Ð‘ÐšÐ'}")
          EOF
          
      - name: Verify file creation
        run: |
          echo "=== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¡ÐžÐ—Ð”ÐÐÐÐžÐ“Ðž Ð¤ÐÐ™Ð›Ð ==="
          if [ -f "hh_vacancies.json" ]; then
            echo "âœ… Ð¤Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
            echo "Ð Ð°Ð·Ð¼ÐµÑ€: $(stat -c%s hh_vacancies.json) Ð±Ð°Ð¹Ñ‚"
            echo "ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°: $(stat -c%a hh_vacancies.json)"
            echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº:"
            head -10 hh_vacancies.json
          else
            echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð¤Ð°Ð¹Ð» Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
            exit 1
          fi
          
      - name: Force git commit
        run: |
          echo "=== ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐ«Ð™ ÐšÐžÐœÐœÐ˜Ð¢ ==="
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾
          git add hh_vacancies.json -f
          
          # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼
          git commit -m "ðŸ”„ Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ JSON $(date)" || echo "ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ"
          git push || echo "Push Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ"
          
      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: "./"
          server-dir: "/home/c54971/gradelift.ru/Vacancy/"
          state-name: ".ftp-deploy-sync-state.json"
          dry-run: false
          log-level: verbose
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/README.md
            **/.ftp-deploy-sync-state.json
            
      - name: Final verification
        run: |
          echo "=== Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ==="
          echo "Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ:"
          if [ -f "hh_vacancies.json" ]; then
            ls -la hh_vacancies.json
            echo "updated_at Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°:"
            grep '"updated_at"' hh_vacancies.json || echo "updated_at Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          else
            echo "âŒ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¸ÑÑ‡ÐµÐ·!"
          fi
          
          echo "âœ… ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ„Ð°Ð¹Ð» Ð½Ð° FTP ÑÐµÑ€Ð²ÐµÑ€Ðµ."
