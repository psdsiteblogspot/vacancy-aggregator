name: Update Vacancies

on:
  schedule:
    # Запуск каждые 6 часов
    - cron: '0 */6 * * *'
  workflow_dispatch: # Ручной запуск
    inputs:
      force_update:
        description: 'Принудительное обновление'
        required: false
        default: 'false'

jobs:
  update-vacancies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml
          
      - name: Test HH API
        run: |
          # Сначала проверяем доступность API простым запросом
          cd ${{ github.workspace }}
          python test_api.py
          
      - name: Update vacancies data
        run: |
          # Если тест прошел, запускаем полное обновление
          cd ${{ github.workspace }}
          python update_vacancies.py
          
      - name: Commit changes (if any)
        run: |
          # Убеждаемся что мы в корневой директории
          cd ${{ github.workspace }}
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Проверяем есть ли изменения в корневой папке
          if [[ -n $(git status --porcelain) ]]; then
            git add hh_vacancies.json
            git commit -m "Автоматическое обновление вакансий $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "Нет изменений для коммита"
          fi
          
      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: "./"
          server-dir: "/home/c54971/gradelift.ru/Vacancy/"
          state-name: ".ftp-deploy-sync-state.json"
          dry-run: false
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/README.md
            **/.ftp-deploy-sync-state.json
            **/update_vacancies.py
