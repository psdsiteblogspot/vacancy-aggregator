name: Test FTP Connection

on:
  workflow_dispatch: # Ручной запуск

jobs:
  test-ftp:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create test file
        run: |
          echo "=== СОЗДАНИЕ ТЕСТОВОГО ФАЙЛА ==="
          cat > test_ftp_connection.txt << EOF
          Тест FTP подключения
          Время: $(date)
          Статус: Тестирование загрузки
          EOF
          
          echo "Тестовый файл создан:"
          cat test_ftp_connection.txt
          
      - name: Test FTP credentials
        run: |
          echo "=== ПРОВЕРКА FTP СЕКРЕТОВ ==="
          if [ -z "${{ secrets.FTP_SERVER }}" ]; then
            echo "❌ FTP_SERVER не установлен!"
          else
            echo "✅ FTP_SERVER: установлен (${#FTP_SERVER} символов)"
          fi
          
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
            echo "❌ FTP_USERNAME не установлен!"
          else
            echo "✅ FTP_USERNAME: установлен (${#FTP_USERNAME} символов)"
          fi
          
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "❌ FTP_PASSWORD не установлен!"
          else
            echo "✅ FTP_PASSWORD: установлен (${#FTP_PASSWORD} символов)"
          fi
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          
      - name: Test FTP connection with curl
        run: |
          echo "=== ТЕСТ ПОДКЛЮЧЕНИЯ ЧЕРЕЗ CURL ==="
          
          # Создаем простой тестовый файл
          echo "Test FTP upload at $(date)" > curl_test.txt
          
          # Пытаемся загрузить через curl
          echo "Попытка загрузки через curl..."
          
          curl -v -T curl_test.txt \
            ftp://${{ secrets.FTP_SERVER }}/home/c54971/gradelift.ru/Vacancy/ \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            --ftp-create-dirs || echo "Curl загрузка не удалась"
            
      - name: Try FTP Deploy Action (simple)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: "./"
          server-dir: "/home/c54971/gradelift.ru/Vacancy/"
          dry-run: false
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/README.md
            **/.ftp-deploy-sync-state.json
            **/update_vacancies.py
            **/minimal_update.py
            **/test_api.py
            
      - name: Verify what happened
        run: |
          echo "=== РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ ==="
          echo "Локальные файлы после FTP деплоя:"
          ls -la
          
          echo ""
          echo "Если FTP работает, файлы должны появиться на сервере."
          echo "Если нет - проверьте секреты в настройках репозитория."
